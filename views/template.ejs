<!DOCTYPE html>
<html>
<head>
  <title>Patient Page</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
  integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
  crossorigin="anonymous"></script>
  <script type="text/javascript" src="/files/js/stickyfillmin.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.js"></script>

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Nunito"/>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="/files/css/contentTable.css">
  <link rel="stylesheet" type="text/css" href="/files/css/contentGeneral.css">
  <link rel="stylesheet" type="text/css" href="/files/css/template.css">



  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.css" rel="stylesheet" type="text/css" />
</head>
<body> 
  <h2 style="display:none;" id="url"></h2>
  <div class="background">
    <div class="sidebarContainer">
      <div class="row">
        <nav class="col-sm-2 sidebar">
          <div class = "sidebar sticky " >
            <div class = "basicInfo"> 
              <h2 id = "name"><%= data.firstName%> <%= data.lastName%></h2>
              <br>
              <p id="ageSex"> , <%=data.sex%></p>
              <p id="dob"><%= data.birthdate%> </p>
              <p id="weightHeight"> <%= data.weight%> kg, <%= data.height%> cm </p>
              <p id="allergiesSide"> Allergies: (loop patient.allergies[i]) </p>
            </div>
            <ul class="nav nav-pills nav-stacked links">
              <li class="active current"><a href='/patientPage/<%=data.id%>'>Patient Summary</a></li>
              <li><a href="/patientPage/<%=data.id%>/history">Information &amp; History </a></li>
              <li><a href="/patientPage/<%=data.id%>/problemList">Problem List</a></li>
              <ul class="subLink">
                <li> <button class="subLinkBtn"> Chronic </button> </li>
                <li> <button class="subLinkBtn"> Acute </button> </li>              </ul>
                <li><a href="/patientPage/<%=data.id%>/medications">Medication List</a></li>
                <ul class="subLink">
                  <li> <button class="subLinkBtn"> Chronic </button> </li>
                  <li> <button class="subLinkBtn"> Acute </button> </li>
                </ul>
                <li><a href="/patientPage/<%=data.id%>/immunization">Immunization Record</a></li>
                <li><a href="/patientPage/<%=data.id%>/allergies">Allergies</a></li>
                <li><a href="/patientPage/<%=data.id%>/wellChildCheck">Well Child Check Page</a></li>
                <ul class="subLink">
                  <li> <button class="subLinkBtn"> Upcoming </button> </li>
                  <li> <button class="subLinkBtn"> Past </button> </li>
                </ul>
                <li><a href="/patientPage/<%=data.id%>/testing">Testing</a></li>
                <ul class="subLink">
                  <li> <button class="subLinkBtn"> HIV </button> </li>
                  <li> <button class="subLinkBtn"> TB </button> </li>
                  <li> <button class="subLinkBtn"> Hemoglobin </button> </li>
                </ul>
                <li><a href="/patientPage/<%=data.id%>/growthCharts">Growth Charts</a></li>
                <li><a href="/patientPage/<%=data.id%>/nurseNotes">Nurse Notes</a></li>
                <ul class="subLink">
                  <li><a href="/patientPage/<%=data.id%>/nurseNotes/vitalSigns">Vital Signs</a></li>
                  <li><a href="/patientPage/<%=data.id%>/nurseNotes/symptomAnalysis"> Symptom Analysis</a></li>
                  <li><a href="/patientPage/<%=data.id%>/nurseNotes/systemAssessments">System Assessments</a></li>
                  <li><a href="/patientPage/<%=data.id%>/nurseNotes/miscellaneous">Miscellaneous</a></li>
<!--
                  <li> <button class="subLinkBtn"> Vital Signs </button> </li>
                  <li> <button type = "submit" class="subLinkBtn"> Symptom Analysis </button></li>
                  <li> <button class="subLinkBtn"> System Assessments </button> </li>
                  <li> <button class="subLinkBtn"> Miscellaneous </button> </li> -->
                </ul>
                <li><a href="/patientPage/<%=data.id%>/scans">Scans</a></li>
                <ul class="subLink">
                  <li> <button class="subLinkBtn"> Doctor's Notes/Referrals </button> </li>
                  <li> <button class="subLinkBtn"> Laboratory Results </button> </li>
                  <li> <button class="subLinkBtn"> Government Documents </button> </li>
                  <li> <button class="subLinkBtn"> Past Nurse Notes </button> </li>
                  <li> <button class="subLinkBtn"> Other </button> </li>
                </ul>
              </ul>
            </div>
          </nav>
          <div class="col-lg">   
            <div class = "card header">
             <div class = "topRight">
              <a> Welcome, "*User Name*"  | </a>
              <a href="/" class="btn btn-outline-success"> Logout </a>
            </div>
            <div>
              <a href="/patientSearch" style="text-decoration : none "> <p class = "label" id = "R-plus"> R+ </p>
                <p class = "label" id = "Childrens">Childrens</p> </a>
                <a href="#Pharmacy" class = "top-nav" id = "pharmacy">Pharmacy</a>
                <a href="#AllPatients" class = "top-nav" id = "rec-pat">Recent Patients</a>
                <a href="/patientSearch" class = "top-nav" id = "search-pat">Search Patients</a>
                <a href="/form" class = "top-nav" id = "search-pat">Add Patient</a>
              </div>
            </div>

            <div id="containers">
              <div id="patientPageContainer"></div>
              <div id="historyContainer"></div>
              <div id="problemListContainer"></div>
              <div id="medicationsContainer"></div>
              <div id="immunizationContainer"></div>
              <div id="allergiesContainer"></div>
              <div id="wellChildCheckContainer"></div>
              <div id="wccFormContainer"></div>
              <div id="wccPageContainer"></div>
              <div id="testingContainer"></div>
              <div id="growthChartsContainer"></div>
              <div id="nurseNotesContainer"></div>
              <div id="vitalSignsContainer"></div>
              <div id="symptomAnalysisContainer"></div>
              <div id="systemAssessmentsContainer"></div>
              <div id="miscellaneousContainer"></div>
              <div id="scansContainer"></div>
              <div id="wellChildCheckContainer"></div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

<script type="text/javascript">

  var patientId = <%=data.id%>;
  console.log(patientId);


  $('document').ready(function() {
    // Getting specific page from URL
    var url = window.location.href;
    var index = url.lastIndexOf('/')
    var subUrl = url.slice(index+1, url.length)
    console.log(subUrl)
    // Loading page content
    if (subUrl == patientId) {
      subUrl = 'patientPage'
    } else if (url.indexOf('wellChildCheck') >= 0 ) {
      var css = "/files/css/wcc.css";
     $.getScript(css);
      if (subUrl == 'form') {
        subUrl = 'wccForm';
      } else if (subUrl == 'page')
      subUrl = 'wccPage'
    }
    $('#'+subUrl+'Container').attr('class','loaded')
    $('#'+subUrl+'Container').load('/files/html/'+subUrl+'Content.html')


    if (url.indexOf('nurseNotes') >= 0 ) {
     var script = "/files/js/nurseNotesScript.js";
     $.getScript(script);
     var css = "/files/css/nurseNotes.css";
     $.getScript(css);
     console.log('here')
   } else {
    var script = "/files/js/pageScript.js";
    $.getScript(script);
    console.log(url)
  }

    // Updating sidebar date of birth and age
    var DOB = $("#dob").html(); 
    $("#dob").html(convertDOB(DOB));
    $('#ageSex').prepend(getAge(DOB));

    updateSidebarLink(subUrl)


    // Shifts page focus to the specfic section
    $(".subLinkBtn").on('click',function() {
      var subLinks = $(this).closest('ul').find('li');
      var subLink = $(this).closest('li');
      var index = ($(subLinks).index(subLink));
      $('.loaded').find('.section');
      var element = $('.loaded').find('.section')[index];
      $('html, body').animate({
        scrollTop: $(element).offset().top
      }, 500);
    });

  });

  // bolds the current link in the sidebar
  function updateSidebarLink(url) {
   var links = $('.links').find('a');
   var url2 = window.location.href;
   var index = url2.lastIndexOf('/')
   var subUrl = url2.slice(index+1, url2.length)

   var urlSub = url.substring(0,4).toLowerCase();
   if (url2.indexOf('nurseNotes') >= 0 ) {
    urlSub = 'nurs'
  }
  console.log(links)
  for (i = 0; i < links.length; i++) {
    var link = links[i].text.toLowerCase();
    console.log( link.indexOf(urlSub) )
      if (link.indexOf(urlSub) >= 0 ) {// true
        console.log(links[i])
        // Bold current page in sidebar
        $(links[i]).css({'font-weight': 'bolder', 'font-size': '1.1em'})
        // Display subLinks 
        $(links[i]).parent().next().show();
      }
    }
  }

  // takes data.birthdate and converts to MM/DD/YYYY
  function convertDOB(dob) {
    var dobSplit = dob.split(' ')
    return getMonthFromString(dobSplit[1]) + '/' + dobSplit[2] + '/' + dobSplit[3];
  }
  // Converts 3 letter month abbreviation to the month number
  function getMonthFromString(mon){
   var d = Date.parse(mon + "1, 2012");
   if(!isNaN(d)){
    return new Date(d).getMonth() + 1;
  }
  return -1;
}


function getAge(fromdate, todate){
  if(todate) todate= new Date(todate);
  else todate= new Date();

  var age= [], fromdate= new Date(fromdate),
  y= [todate.getFullYear(), fromdate.getFullYear()],
  ydiff= y[0]-y[1],
  m= [todate.getMonth() + 1, fromdate.getMonth()],
  mdiff= m[0]-m[1],
  d= [todate.getDate(), fromdate.getDate()],
  ddiff= d[0]-d[1];

  if(mdiff < 0 || (mdiff=== 0 && ddiff<0))--ydiff;
  if(mdiff<0) mdiff+= 12;
  if(ddiff<0){
    fromdate.setMonth(m[1]+1, 0);
    ddiff= fromdate.getDate()-d[1]+d[0];
    --mdiff;
  }
  w = Math.floor(ddiff/7);
  ddiff = ddiff % 7;
                  // 3 or older -> show year
                  if (ydiff > 2) age.push(ydiff+ ' year'+(ydiff> 1? 's ':' '));
                  else if (ydiff> 0) {
                    // Over a year -> show year and month
                    age.push(ydiff+ ' year'+(ydiff> 1? 's ':' '));
                    if(mdiff> 0) age.push(mdiff+ ' month'+(mdiff> 1? 's':''));
                    // Less than a year -> show month and day
                  } else if (mdiff> 3) {
                    age.push(mdiff+ ' month'+(mdiff> 1? 's':''));
                    if (w> 0) age.push(w+ ' week' + (w> 1? 's':''));
                  } else if (mdiff>0) {
                    age.push(mdiff+ ' month'+(mdiff> 1? 's ':' '));
                    if(w> 0) age.push(w+ ' week'+(w> 1? 's':''));
                  } else {
                    if(w> 0) age.push(w+ ' week'+(w> 1? 's':''));
                    if(ddiff> 0) age.push(ddiff+ ' day'+(ddiff> 1? 's':''));
                  }

                  if(age.length>1) age.splice(age.length-1,0,' and ');    
                  return age.join('');
                }

/*
  $('document').ready(function() {
    console.log("document.ready ajax call: ");
      // // ajax call to render the original table, where we post to getAllWeights
      // // we return a JSON in which we call updateTable with 
      $.ajax({
       type: "POST",
       url: "/getAllChronic",
       data : {
         id: patientId
       },
       success: function(data) {
         console.log(data);
         if(data.data.length != 0){
          updateTableChronic(data.data[0].chronicEntries);
        }
      }
    });
      $.ajax({
       type: "POST",
       url: "/getAllAcute",
       data : {
         id: patientId
       },
       success: function(data) {
         console.log(data);
         if(data.data.length != 0){
          updateTableAcute(data.data[0].acuteEntries);
        }
      }
    });
      // ajax call that on submit will send the new chronic problem values to the database
      $('#chronicSubmit').click(function(e) {
        e.preventDefault();
        var input = $("#chronicForm").serializeArray();

        console.log("got here: ");
        console.log(input);
        $.ajax({
          type: "POST",
          url: "/chronicProblem",
          data : {
            id: patientId, 
            chronicDiagnosis: input[0].value,
            chronicDetails: input[1].value, 
            chronicTreatment: input[2].value,
            chronicDateOnset: input[3].value,  
            chronicEndDate: input[4].value,  
          },
          success: function(data) {
            console.log("New chronic data: ");
            console.log(data);
            updateTableChronic(data.data[0].chronicEntries);
            $('#chronicForm')[0].reset();
            $('#chronicForm').hide();
            $('#chronicForm').parent().find('button').show();
          }
        });
      });
      $('#acuteSubmit').click(function(e) {
        e.preventDefault();
        var input = $("#acuteForm").serializeArray();
        console.log("got here: ");
        console.log(input);
        $.ajax({
          type: "POST",
          url: "/acuteProblem",
          data : {
            id: patientId, 
            acuteDiagnosis: input[0].value,
            acuteDetails: input[1].value, 
            acuteTreatment: input[2].value,
            acuteDateOnset: input[3].value,  
            acuteEndDate: input[4].value,  
          },
          success: function(data) {
            console.log("New chronic data: ");
            console.log(data);
            updateTableAcute(data.data[0].acuteEntries);
            $('#acuteForm')[0].reset();
            $('#acuteForm').hide();
            $('#acuteForm').parent().find('button').show();
          }
        });
      });
    });

  // function that takes in JSON with two fields: height and date and renders the table as such
  var updateTableChronic = function(data) {
   console.log(data);
   var table1 = '';
   for(var i = 0; i < data.length; i++) {
     var line = '<tr><td>' +  data[i].chronicDiagnosis + '</td>';
     line += '<td>' + data[i].chronicDetails + '</td>';
     line += '<td>' + data[i].chronicTreatment + '</td>';
     line += '<td>' + data[i].chronicDateOnset + '</td>';
     line += '<td>' + data[i].chronicEndDate + '</td>';
     line += '<td><button class="editBtn btn">Edit</button></td></tr>';
     table1 += line;
   }
   document.getElementById('chronicTableBody').innerHTML = table1;
 };
 var updateTableAcute = function(data) {
   console.log(data);
   var table1 = '';
   for(var i = 0; i < data.length; i++) {
     var line = '<tr><td>' +  data[i].acuteDiagnosis + '</td>';
     line += '<td>' + data[i].acuteDetails + '</td>';
     line += '<td>' + data[i].acuteTreatment + '</td>';
     line += '<td>' + data[i].acuteDateOnset + '</td>';
     line += '<td>' + data[i].acuteEndDate + '</td>';
     line += '<td><button class="editBtn btn">Edit</button></td></tr>';
     table1 += line;
   }
   document.getElementById('acuteTableBody').innerHTML = table1;
 };
 */
</script>
</html>
