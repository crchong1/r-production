  

  <div class = "content-container">
   <div class = "card summary">
    <h3 class="pageTitle"> Information &amp; History </h3>
  </div>
</div>



<div class = "card box content-container">
  <div class = "">
    <div class="title"> General Information </div>
  </div>
  <div class="row">
    <div class="col">
      <div>
        <div class="subTitle">At a glance</div>
        <div class="row box">
          <div class="col-md-1">
            <div> Sex: </div>
            <div> Age: </div>
            <div> Height: </div>
            <div> Weight: </div>
          </div>
          <div class="col-md-3">
            <div> M </div>
            <div> 3 y 4 m </div>
            <div> 100 cm </div>
            <div> 20 kg </div>

          </div>
          <div class="col-md-2">
            <div> Date of birth: </div>
            <div> Allergies: </div>
            <div> House: </div>
            <div> Date arrived at PC: </div>
          </div>
          <div class="col-md-6">
            <div> 01/02/2001 </div>
            <div> Peanuts </div>
            <div> Emseni 4 </div>
            <div> 02/02/2004 </div>

          </div>
        </div>
      </div>

    </div>
  </div>
  <div class="row">
    <div class="col">
      <div class=" subTitle">Growth Measurements</div>
      <div class="box2">
        <div class="row labels">
          <div class="col"> Age </div>
          <div class="col"> Date </div>
          <div class="col"> Length/Height </div>
          <div class="col"> Weight </div>
          <div class="col"> BMI </div>
        </div>

        <div class="row">
          <div class="col">
            <div> 1 month</div>
            <div> 2 months </div>
            <div> 4 months </div>
            <div> 6 months </div>
          </div>

          <div class="col">
            <div> 12-12-2001 </div>
            <div> 12-12-2001 </div>
            <div> 12-12-2001 </div>
            <div> 12-12-2001 </div>
          </div>
          <div class="col">
            <div> --- </div>
            <div> --- </div>
            <div> --- </div>
            <div> --- </div>
          </div>
          <div class="col">
            <div> --- </div>
            <div> --- </div>
            <div> --- </div>
            <div> --- </div>
          </div>
          <div class="col">
            <div> --- </div>
            <div> --- </div>
            <div> --- </div>
            <div> --- </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class = "card box content-container section">
  <div class = "">
    <div class="title"> Living History </div>
  </div>

  <div class="row labels">
    <div class="col"> House </div>
    <div class="col"> Start Age </div>
    <div class="col"> From </div>
    <div class="col"> To </div>
    <div class="col edit"> Edit </div>
  </div>

  <div class="box2">
    <div class="row">
      <div class="col"><div> Emseni</div></div>
      <div class="col"><div> -- y</div></div>
      <div class="col"><div> 12/12/2001</div></div>
      <div class="col"><div> 11/11/2002</div></div>
      <div class="col"><div><button class="editBtn btn">Edit</button></div></div>
    </div>
    <div class="row">
      <div class="col"><div> Toddler Home</div></div>
      <div class="col"><div> -- y</div></div>
      <div class="col"><div> 12/12/2003</div></div>
      <div class="col"><div> 11/11/2004</div></div>
      <div class="col"><div><button class="editBtn btn">Edit</button></div></div>
    </div>
  </div>



  <form id="livingHistoryForm" class="addForm" method="post" >
    <div class="row">
      <span class="col"><input type="text" name="house" placeholder="House"></span>
      <span class="col"><input type="text" name="startAge" placeholder="Start Age"></span>
      <span class="col"><input type="text" name="livingFrom" class="datepicker form-control" ></span>
      <span class="col"><input type="text" name="livingTo" class="datepicker form-control" ></span>
    </div>
    <div>
      <input type="submit" value="Submit" name="livingSubmit" class="formSubmit">
      <input type="button" value="Cancel" name="cancel" class="formSubmit cancel"></div>
    </form>

    <div> <button id="addLivingHistory" class="add"> + </button>
    </div>
  </div>

  <div class = "card box content-container section">
    <div class = "">
      <div class="title"> Feeding History </div>
    </div>

    <div class="row labels">
      <div class="col"> Underweight? </div>
      <div class="col"> Brand </div>
      <div class="col"> Amount per day </div>
      <div class="col"> Additions </div>
      <div class="col"> From </div>
      <div class="col"> To </div>
      <div class="col edit"> Edit </div>

    </div>
    <div class="box2">
      <div class="row">
        <div class="col"><div> No</div></div>
        <div class="col"><div> Quaker</div></div>
        <div class="col"><div> 30 mL</div></div>
        <div class="col"><div> 5 mL cocounut oil</div></div>
        <div class="col"><div> 12/12/2001</div></div>
        <div class="col"><div> 11/11/2002</div></div>
        <div class="col"><div><button class="editBtn btn">Edit</button></div></div>
      </div>
      <div class="row">
        <div class="col"><div> Yes</div></div>
        <div class="col"><div> Quaker</div></div>
        <div class="col"><div> 30 mL</div></div>
        <div class="col"><div> 5 mL cocounut oil</div></div>
        <div class="col"><div> 12/12/2001</div></div>
        <div class="col"><div> 11/11/2002</div></div>
        <div class="col"><div><button class="editBtn btn">Edit</button></div></div>
      </div>
      <div class="row">
        <div class="col"><div> Yes</div></div>
        <div class="col"><div> Quaker</div></div>
        <div class="col"><div> 30 mL</div></div>
        <div class="col"><div> 5 mL cocounut oil</div></div>
        <div class="col"><div> 12/12/2001</div></div>
        <div class="col"><div> 11/11/2002</div></div>
        <div class="col"><div><button class="editBtn btn">Edit</button></div></div>
      </div>
    </div>


    <form id="feedingHistoryForm" class="addForm" method="post" >
      <div class="row">
        <span class="col"><input type="radio" name="underweight"></span>
        <span class="col"><input type="text" name="brand" placeholder="Brand"></span>
        <span class="col"><input type="text" name="amount" placeholder="Amount per day"></span>
        <span class="col"><input type="text" name="additions" placeholder="Additions"></span>
        <span class="col"><input type="text" name="from" class="datepicker form-control" ></span>
        <span class="col"><input type="text" name="to" class="datepicker form-control" ></span>
      </div>
      <div>
        <input type="submit" value="Submit" name="feedingSubmit" class="formSubmit">
        <input type="button" value="Cancel" name="cancel" class="formSubmit cancel"></div>
      </form>

      <div> <button id="addFeedingHistory" class="add"> + </button>
      </div>
    </div>

    <div class = "card box content-container section">
      <span class="section">
        <div class = "header">
          <div class="title"> Social History
            <button class="editCard btn" style="float: right;">Edit</button>
          </div>
        </div>
        <div class="box2 container1">
          <div class="row">
            <div class="col-md-2"><div> Location: </div></div>
            <div class="col-md-2"><div> Mbabane</div></div>
          </div>
          <div class="row">
            <div class="col-md-2"><div> Mother: </div></div>
            <div class="col-md-2"><div> Wendy Dlamini</div></div>
          </div>
          <div class="row">
            <div class="col-md-2"><div> Father: </div></div>
            <div class="col-md-2"><div>  --- </div></div>
          </div>
        </div>

        <form id="socialHistoryForm" class="addForm" method="post" >

          <div class="row">
            <div class="col-md-1"><div> Location: </div></div>
            <div class="col-md-2"><input type="text" name="location" placeholder="Location"></div>
          </div>
          <div class="row">
            <div class="col-md-1"><div> Mother: </div></div>
            <div class="col-md-2"><div><input type="text" name="mother" placeholder="Mother"></div></div>
          </div>
          <div class="row">
            <div class="col-md-1"><div> Father: </div></div>
            <div class="col-md-2"><div><input type="text" name="father" placeholder="Father"></div></div>
          </div>


          <div>
            <input type="submit" value="Submit" name="socialHistorySubmit" class="formSubmit">
            <input type="button" value="Cancel" name="cancel" class="formSubmit cancelCardEdit"></div>
          </form>

        </span>
        <span class="section">
          <div class = "header">
            <div class="title"> Background 
              <button class="editCard btn" style="float: right;">Edit</button></div>
            </div>

            <div class="box2 container1">
              <div class="row">
                <div class="col">
                  <div id="backgroundInfo"> Left on side of road </div>
                </div>
              </div>
            </div>


            <form id="backgroundForm" class="addForm" method="post" >

             <textarea type="text" name="background" ></textarea>


             <div>
              <input type="submit" value="Submit" name="backgroundSubmit" class="formSubmit">
              <input type="button" value="Cancel" name="cancel" class="formSubmit cancelCardEdit"></div>
            </form>

          </span>

        </div>
      </div>


      <script> 

        $(document).ready(function(){
        //  $('#header').load('/files/html/header.html');


        $(function () {
          $('.datepicker').datepicker({ 
            autoclose: true, 
            todayHighlight: true
          }).datepicker('update', new Date());
        });

    // Make sidebar sticky
    var elements = document.querySelectorAll('.sticky');
    Stickyfill.add(elements);

/*
    // Initial Page Load
    $.ajax({
    type: 'POST',
    url: '/getPatientKeys',
    data: {
    search: '',
    field: 'lastName',
  },
  success: function(result) {
  patients = result.patient;
  getPatientData(result.patient);
}
});
*/

// Show and hide buttons and forms on click
$('form').hide();
$('.add').on('click', function() {
  $(this).hide();
  $(this).parent().parent().find('.addForm').show();
  setCss(this);
  console.log('add form')



});

$('.section').on('click', '.editBtn', function() {
  $('.editBtn').hide()
  var row = $(this).closest('.row');
  $(row).attr('id', 'editingRow');
  console.log(row)
  row.hide();
//  editEntry(row);
editEntryGeneric(row);
setCss(this);

// row.remove();

});


$('.section').on('click', '.editCard', function() {
  $('.editBtn').hide();
  $('.editCard').hide();
  var content = $(this).closest('.section').find('.container1');
  $(content).attr('id', 'editingRow');
  content.hide();
  var form = $('#editingRow').closest('.section').find('form')[0];
  var background = $('#backgroundInfo')[0].innerHTML;
  $(form).find('textarea').attr({'value': background})
  $(form).show();
});
// Cancel edit and re-display entry
$('.section').on('click', '.cancelCardEdit',function(event) {
  console.log('cancel edit')
  var form = $('#editingRow').closest('.section').find('form')[0];
  $(form).hide();
  $('#editingRow').show();
  $('.editBtn').show();
  $('.editCard').show();
  $('#editingRow').removeAttr('id');
});

// Cancel edit and re-display entry
$('.section').on('click', '.cancelEdit',function(event) {
  console.log('cancel edit')
  var form = '#' + $(this).closest('.section').find('form').attr('id');
  $(form).remove();
  $('#editingRow').show();
  $('.editBtn').show();
  $('#editingRow').removeAttr('id');
});

// Cancel new entry
$('.section').on('click', '.cancel',function(event) {
  var form = '#' + $(this).closest('.section').find('form').attr('id');
  console.log('cancel')
  $(form)[0].reset();
  $(form).hide();
  $(form).closest('.section').find('.add').show();
});

// Handles deletion of entry
$('.section').on('click', '.delete',function(event) {
  console.log('delete entry')
  var form = '#' + $(this).closest('.section').find('form').attr('id');
  $(form).remove();
  alert('Are you sure you want to delete this entry?')
  $('#editingRow').remove();
  $('.editBtn').show();
});

// Handles for submission for adding new entry
$('.section').on('submit', '.addForm', function(event) {
  event.preventDefault();
  console.log("on submit");
  var formData = $(this).serializeArray();
  var form = this.id;
  var type = form.substring(0, ((form.length)-4));

  $.ajax({
    type: 'POST',
    url: '/addTest',
    data: { 
      formData,
      form: form,
      type: type
    },

    success: function (result) {
      var form = '#' + result.data.form;
      $(form)[0].reset();
      $(form).hide();
      console.log('add form reset')
      $(form).closest('.section').find('.add').show();
      updateTable(result.data, result.data.type);
    },
    error: function(XMLHttpRequest, textStatus, errorThrown) {
      console.error("error: " + errorThrown);
    }
  });

});

// Handles for submission for editing existing entry
$('.section').on('submit', '.editForm', function(event) {
  event.preventDefault();
  console.log("on submit");
  var formData = $(this).serializeArray();
  var form = this.id;
  var type = form.substring(0, ((form.length)-4));

  $.ajax({
    type: 'POST',
    url: '/addTest',
    data: { 
      formData,
      form: form,
      type: type
    },


    success: function (result) {
      console.log(result);
      var form = '#' + result.data.form;
      var hiddenRow = $(form).prev();
      hiddenRow.remove();

      console.log(result.data.type)
// $(form).hide();
$('.editBtn').show();
$('#editForm').remove();

updateTable(result.data, result.data.type);

},
error: function(XMLHttpRequest, textStatus, errorThrown) {
  console.error("error: " + errorThrown);
}
});

});

});

// Not right, need to update based on all data in the patient, not just append as most recent
var updateTable = function(data, type ) {
  var formData = data.formData;
  var table = '#' + type + 'TableBody'
  var tableData = '<tr>';
  for (i = 0; i < formData.length; i++) {
    tableData += '<td>' + formData[i].value + '</td>'
  }
  tableData += '<td><button class="edit btn">Edit</button></td></tr>'
  $(table).append(tableData);
}


var setCss = function(thiss) {
  var form = $(thiss).closest('.section').find('form');
  $(form).first().css("display", "inline-flex")
  var formElms = $(form).find('div').children('span')
  var items = $(thiss).closest('.section').find('tr').children('th'); 
  if (items.length == 0) {
    var items = $(thiss).closest('.section').find('.labels').children('div'); 
  }
  for (var i = 0; i < items.length - 1; i++) {
    var width = (items[i].offsetWidth).toString() + 'px';
    var elm = formElms[i];

    $(elm).css({'width': width, 'padding': '4px'})
    $(elm).children().css({'background':'#f6f6f7', 'max-width':width,'border-width':'2px', 'border-radius': '3px'});
  }
} 

var editEntryGeneric = function(row) {
// getting values from row
var data = [];
var table = document.getElementById("editingRow"); 
var cells = $(table).children('div').children('div');
for (var i = 0; i < cells.length; i++) {
  data.push(cells[i].innerHTML);
}

var form = $('#editingRow').closest('.section').find('form')[0].outerHTML;
$(row).after(form);
$(row).next().attr('id', 'editForm')
// getting form input name fields
var items = $("#editForm :input").map(function(index, elm) {
  return {name: elm.name, type:elm.type, value: $(elm).val()};
});
// setting form name attributes to be same as previous values
for (var i = 0; i < items.length - 2; i++) {
// For select boxes
if (items[i].type === 'select-one') {
  var match = data[i].toString();
  var itemName = items[i].name.toString();
  var name = '[name="' + itemName + '"] option[value="' + match + '"]';
  $(name).attr("selected", "selected")

// For radio boxes
} else if (items[i].type === 'radio') {
  if (data[i].toString().trim() == 'Yes') {
    var item = items[i].name
    var name = 'input[name="' + item + '"]'
    $(name).first().prop('checked', true);
  }

// For text boxes and date
} else {
  var name = '#editForm input[name=' + items[i].name;
  var val = data[i];
  $(name).attr('value', val)
}

}
// finalizing form appearance
$('#editForm').attr('class', 'editForm')
//$('#editForm').show();
$('#editForm').find("[name='cancel']").attr('class', 'formSubmit cancelEdit')
$('#editForm').find("[value='Submit']").before('')
$('#editForm').find('.cancelEdit').after('<input type="button" value="Delete" name="delete" class="formSubmit delete"/>');

}


// Displays the patient's data on page
var getPatientData = function(patient) {
  var temp = patient;
// temporary data
var allergies = [{allergen: 'peanut', severity: 'mild', reaction: 'throat closure', onsent: '12-08-2009', notes: 'avoid tree nuts in general, especially almonds'}];
console.log('here:' + patient);

var cards = "";
var date = new Date(2018,2,12);
var i = 1;
var patient = patient[i];

// Update sidebar content
$('#name').text(patient.firstName + ' ' + patient.lastName);
$('#ageSex').text(getAge(patient.birthdate) + ', ' + 'F' ); //paitient.sex
$('#dob').text(patient.birthdate);
$('#heightWeight').text(patient.height + " cm, " + patient.weight + " kgs");
$('#allergiesSide').text('Allergies: ' + allergies[0].allergen );

}

function getAge(fromdate, todate){
  if(todate) todate= new Date(todate);
  else todate= new Date();

  var age= [], fromdate= new Date(fromdate),
  y= [todate.getFullYear(), fromdate.getFullYear()],
  ydiff= y[0]-y[1],
  m= [todate.getMonth() + 1, fromdate.getMonth()],
  mdiff= m[0]-m[1],
  d= [todate.getDate(), fromdate.getDate()],
  ddiff= d[0]-d[1];

  if(mdiff < 0 || (mdiff=== 0 && ddiff<0))--ydiff;
  if(mdiff<0) mdiff+= 12;
  if(ddiff<0){
    fromdate.setMonth(m[1]+1, 0);
    ddiff= fromdate.getDate()-d[1]+d[0];
    --mdiff;
  }
  w = Math.floor(ddiff/7);
  ddiff = ddiff % 7;
// 3 or older -> show year
if (ydiff > 2) age.push(ydiff+ ' year'+(ydiff> 1? 's ':' '));
else if (ydiff> 0) {
// Over a year -> show year and month
age.push(ydiff+ ' year'+(ydiff> 1? 's ':' '));
if(mdiff> 0) age.push(mdiff+ ' month'+(mdiff> 1? 's':''));
// Less than a year -> show month and day
} else if (mdiff> 3) {
  age.push(mdiff+ ' month'+(mdiff> 1? 's':''));
  if (w> 0) age.push(w+ ' week' + (w> 1? 's':''));
} else if (mdiff>0) {
  age.push(mdiff+ ' month'+(mdiff> 1? 's ':' '));
  if(w> 0) age.push(w+ ' week'+(w> 1? 's':''));
} else {
  if(w> 0) age.push(w+ ' week'+(w> 1? 's':''));
  if(ddiff> 0) age.push(ddiff+ ' day'+(ddiff> 1? 's':''));
}

if(age.length>1) age.splice(age.length-1,0,' and ');    
return age.join('');
}




</script>



